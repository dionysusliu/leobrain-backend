server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push

scrape_configs:
  # Docker 容器日志收集（自动发现）
  - job_name: docker
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
    relabel_configs:
      - source_labels: ['__meta_docker_container_name']
        regex: '/(.*)'
        target_label: 'container'
      - source_labels: ['__meta_docker_container_log_stream']
        target_label: 'logstream'
      - source_labels: ['__meta_docker_container_label_com_docker_compose_service']
        target_label: 'service'
      # 只收集 leobrain 相关的容器日志
      - source_labels: ['__meta_docker_container_name']
        regex: 'leobrain-.*'
        action: keep
    # 解析 JSON 格式的日志
    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            level: level
            logger: logger
            message: message
            module: module
            function: function
            line: line
            flow_run_id: flow_run_id
            task_run_id: task_run_id
            flow_run_name: flow_run_name
            task_run_name: task_run_name
            # 添加额外的上下文字段
            site_name: site_name
            url: url
            source: source
            error_type: error_type
      - labels:
          level:
          logger:
          service:
          container:
          flow_run_name:  
          task_run_name:
      # 移除不需要的 labels
      - labeldrop:
          - service_name
          - unknown_service
      - timestamp:
          source: timestamp
          format: RFC3339Nano

  # Backend API logs (from file)
  - job_name: backend-api
    static_configs:
      - targets:
          - localhost
        labels:
          __path__: /var/log/leobrain/leobrain-api.log
          service: 'api'
          job: 'backend-api'
    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            level: level
            logger: logger
            message: message
            module: module
            function: function
            line: line
      - labels:
          level:
          logger:
          service:
      - timestamp:
          source: timestamp
          format: RFC3339Nano